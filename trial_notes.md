| CONTEXTPROCESSOR            |                     |                               |                                                                 |              |                              |                                   |                     |                        |              |
|-----------------------------|---------------------|-------------------------------|-----------------------------------------------------------------|--------------|------------------------------|-----------------------------------|---------------------|------------------------|--------------|
|                             |                     |                               |                                                                 |              |                              |                                   |                     |                        |              |
|                             | REQUEST.SITE_ORIGIN | REQUEST.GET                   | trial_ID_SITE_ID                                                | Cookie State | Route                        | Additional Template Data          | Cookies Set/Cleared | data added to response | Cache Action |
| Trial.get_for_site(request) |                     |                               |                                                                 |              |                              |                                   |                     |                        |              |
|                             | 1                   |                               | return cache.get('trial_1'), Trial.objects.(site_id=1).latest() | None         | continue                     |                                   |                     |                        |              |
| CONTEXTPROCESSOR            |                     |                               |                                                                 |              |                              |                                   |                     |                        |              |
|                             |                     |                               | beta_1                                                          | None         |                              | trial=Trial.get_for_site(request) |                     |                        |              |
| PROCESS_REQUEST             |                     |                               |                                                                 |              |                              |                                   |                     |                        |              |
|                             |                     | trial_%(id)s_%(site_id)s=True |                                                                 |              |                              |                                   |                     |                        |              |
|                             |                     |                               | beta_1                                                          | None         | beta.wnyc.org                | beta_1:True                       | beta_1=True - set   |                        |              |
|                             |                     |                               | beta_1                                                          | None         |                              | beta_1:False                      | beta_1=False - set  |                        |              |
|                             |                     |                               | beta_1                                                          | beta_1=True  | beta.wnyc.org                |                                   |                     |                        |              |
|                             |                     |                               | beta_1                                                          | beta_1=False | www.wnyc.org                 |                                   |                     |                        |              |
|                             |                     |                               | beta_2                                                          | beta_1=True  | beta.wnyc.org/exit_interview | beta:beta_1_in                    | beta_1_in - clear   |                        |              |
|                             |                     |                               | beta_2                                                          | beta_1=False | www.wnyc.org                 |                                   | beta_1_out - clear  |                        |              |
| PROCESS_RESPONSE            |                     |                               |                                                                 |              |                              |                                   |                     |                        |              |
|                             |                     |                               | beta_1                                                          | None         |                              |                                   |                     | beta_1 trial json      |              |
|                             |                     |                               | beta_1                                                          | beta_1=True  | False                        |                                   |                     |                        | None         |
|                             |                     |                               |                                                                 |              |                              |                                   |                     |                        |              |
| function                         | Cookie State         | request data                                               | Site | active trial for site  | active trial cachekey | data modified                                           | route modified   |
|----------------------------------|----------------------|------------------------------------------------------------|------|------------------------|-----------------------|---------------------------------------------------------|------------------|
| TrialMiddleware.process_response |                      |                                                            |      |                        |                       |                                                         |                  |
|                                  | None                 | n/a                                                        | 1    |  id = 5                | active_trial_1        | request.active_trial_data = active_trial_1.to_jsonapi() | none             |
|                                  | active_trial_1=True  | n/a                                                        | 1    | ""                     | ""                    | request.active_trial_data = {}                          | redirect to beta |
|                                  | active_trial_1=False | n/a                                                        | 1    | ""                     | ""                    | ""                                                      | None             |
| TrialMiddleware.process_request  |                      |                                                            |      |                        |                       |                                                         |                  |
|                                  | n/a                  | {}                                                         | 1    | ""                     | ""                    | None                                                    | None             |
|                                  | ""                   | .GET{active_trial_1=True}                                  | 1    | ""                     | ""                    | response.set_cookie(active_trial_1, True)               |                  |
|                                  | ""                   | .GET{active_trial_1=False}                                 | 1    | ""                     | ""                    | response.set_cookie(active_trial_1, False)              |                  |
|                                  |                      |                                                            |      |                        |                       |                                                         |                  |
| trial_context_processor          |                      |                                                            |      |                        |                       |                                                         |                  |
|                                  | n/a                  | request.active_trial_data=None                             |      |                        |                       | None                                                    |                  |
|                                  |                      | request.active_trial_data={active_trial_data_jsonapi_dict} |      |                        |                       | active_trial key added to context                       |                  |
